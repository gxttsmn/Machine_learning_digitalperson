# 模型文件说明

## 🎯 最终模型文件

**最终用于推理的模型文件是：**

```
checkpoints/best_model.pth
```

## 📦 模型文件类型

训练过程中会生成两种类型的模型文件：

### 1. 最佳模型（推荐使用）⭐

**文件路径：** `checkpoints/best_model.pth`

**特点：**
- ✅ **验证集上表现最好的模型**
- ✅ 自动保存（当验证损失达到最低时）
- ✅ 训练过程中会不断更新（如果后续epoch有更好的结果）
- ✅ **这是最终用于推理的模型文件**

**保存时机：**
- 每当验证损失（val_loss）达到新的最低值时自动保存
- 训练过程中可能被多次更新

### 2. 定期检查点（备用）

**文件路径：** `checkpoints/checkpoint_epoch_N.pth`

**特点：**
- 每10个epoch保存一次（可在config.yaml中配置）
- 文件名包含epoch编号，如：`checkpoint_epoch_10.pth`、`checkpoint_epoch_20.pth`
- 用于恢复训练或对比不同epoch的模型

**保存时机：**
- 每 `save_interval` 个epoch保存一次（默认10）

## 📋 模型文件内容

模型文件（.pth）是一个PyTorch检查点文件，包含：

```python
{
    'epoch': 50,                    # 训练轮数
    'model_state_dict': {...},     # 模型权重（最重要的部分）
    'optimizer_state_dict': {...}, # 优化器状态（用于恢复训练）
    'val_loss': 0.1234,            # 验证损失
    'config': {...}                # 训练配置
}
```

## 🔍 如何确认模型文件

### 方法1：查看文件是否存在

```bash
# Windows
dir checkpoints\best_model.pth

# Linux/Mac
ls checkpoints/best_model.pth
```

### 方法2：查看模型信息

```python
import torch

# 加载模型文件
checkpoint = torch.load('checkpoints/best_model.pth', map_location='cpu')

print(f"训练轮数: {checkpoint['epoch']}")
print(f"验证损失: {checkpoint['val_loss']:.4f}")
print(f"模型参数数量: {sum(p.numel() for p in checkpoint['model_state_dict'].values()):,}")
```

## 🚀 使用模型文件

### Python代码调用

```python
from src.inference import LipSyncInference

# 使用最佳模型进行推理
inference = LipSyncInference(
    checkpoint_path="checkpoints/best_model.pth"
)

# 计算同步分数
score, details = inference.compute_sync_score(
    video_path="test_video.mp4",
    audio_path="test_audio.wav"
)
```

### 命令行调用

```bash
python src/inference.py \
    --checkpoint checkpoints/best_model.pth \
    --video input_video.mp4 \
    --audio input_audio.wav \
    --output output_video.mp4
```

## 📊 训练过程中的文件生成

训练100个epoch的示例：

```
checkpoints/
├── best_model.pth              ← 最佳模型（最终使用这个）
├── checkpoint_epoch_10.pth     ← 第10个epoch的检查点
├── checkpoint_epoch_20.pth     ← 第20个epoch的检查点
├── checkpoint_epoch_30.pth
├── ...
└── checkpoint_epoch_100.pth
```

## ⚠️ 注意事项

1. **文件大小**
   - 模型文件通常较大（几十MB到几百MB）
   - 取决于模型架构和参数数量

2. **文件位置**
   - 默认保存在 `checkpoints/` 目录
   - 可在 `config.yaml` 中修改 `paths.checkpoint_dir`

3. **文件格式**
   - 使用PyTorch的 `.pth` 格式
   - 只能通过PyTorch加载

4. **最佳模型选择**
   - 始终使用 `best_model.pth` 进行推理
   - 这是验证集上表现最好的模型
   - 不要使用 `checkpoint_epoch_N.pth` 除非有特殊需求

## 🔧 常见问题

### Q1: 训练完成后没有 best_model.pth 文件？
**A:** 可能的原因：
- 训练过程中验证损失没有下降
- 训练被提前中断
- 检查 `checkpoints/` 目录中是否有其他检查点文件

### Q2: 可以使用 checkpoint_epoch_N.pth 吗？
**A:** 可以，但不推荐。`best_model.pth` 是验证集上表现最好的模型，通常效果更好。

### Q3: 如何恢复训练？
**A:** 可以加载检查点文件继续训练（需要修改train.py添加恢复训练功能）。

### Q4: 模型文件太大怎么办？
**A:** 可以考虑：
- 模型量化（torch.quantization）
- 模型剪枝
- 使用更小的模型架构

## 📝 总结

| 文件 | 用途 | 推荐度 |
|------|------|--------|
| `checkpoints/best_model.pth` | **最终推理模型** | ⭐⭐⭐⭐⭐ |
| `checkpoints/checkpoint_epoch_N.pth` | 训练检查点（备用） | ⭐⭐ |

**最终答案：使用 `checkpoints/best_model.pth` 进行推理！**

